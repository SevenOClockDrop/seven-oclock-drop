<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SevenO'Clock Drop</title>
  <script src="https://sdk.pi.network/pi-sdk.js"></script>
  <script>Pi.init({ version: "2.0", sandbox: true })</script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Inter&display=swap');
    body { margin: 0; font-family: 'Inter', sans-serif; background-color: #121212; color: #FFFFFF; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
    .container { text-align: center; max-width: 400px; padding: 20px; z-index: 1; }
    .title { font-family: 'Orbitron', sans-serif; font-size: 2rem; color: #00FFFF; margin-bottom: 20px; }
    .pot-display { position: relative; margin: 20px auto; width: 200px; height: 200px; }
    .pot-ring { width: 100%; height: 100%; border: 5px solid #8A2BE2; border-radius: 50%; animation: pulse 2s infinite; }
    .pot-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; color: #FF00FF; font-family: 'Orbitron', sans-serif; }
    .countdown label { font-size: 0.9rem; color: #CCCCCC; }
    #timer { font-size: 1.5rem; color: #00FFFF; margin: 10px 0; font-family: 'Orbitron', sans-serif; }
    .cta-button { background: linear-gradient(90deg, #00FFFF, #FF00FF); border: none; color: white; padding: 12px 24px; font-size: 1rem; border-radius: 30px; cursor: pointer; animation: pulse 1.5s infinite; margin-top: 10px; }
    .entry-info { margin-top: 15px; font-size: 1rem; color: #CCCCCC; }
    .referral { margin-top: 20px; }
    .referral label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #CCCCCC; }
    .referral input { padding: 8px; width: 80%; border-radius: 8px; border: 1px solid #8A2BE2; background-color: #000; color: #FFFFFF; }
    .referral-button { margin-top: 10px; padding: 8px 16px; background: linear-gradient(90deg, #00FFFF, #FF00FF); border: none; border-radius: 20px; color: white; cursor: pointer; font-size: 0.9rem; }
    .referral-status { margin-top: 10px; font-size: 0.9rem; color: #00FFAA; min-height: 1.2em; }
    #particles-js { position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: 0; }
    @keyframes pulse { 0% { box-shadow: 0 0 5px #00FFFF; } 50% { box-shadow: 0 0 20px #FF00FF; } 100% { box-shadow: 0 0 5px #00FFFF; } }
    
    /* Styles for the Payment Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: #1e1e1e; padding: 20px; border-radius: 15px; border: 1px solid #8A2BE2; width: 90%; max-width: 350px; box-shadow: 0 0 25px #FF00FF; }
    .modal-title { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; color: #00FFFF; margin-bottom: 20px; }
    .tier-button { display: block; width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #00FFFF; background-color: #121212; color: #FFFFFF; font-size: 1rem; cursor: pointer; text-align: left; }
    .tier-button:hover { background-color: #8A2BE2; }
    .tier-entries { font-weight: bold; color: #00FFFF; }
    .tier-bonus { font-size: 0.8rem; color: #00FFAA; }
    .modal-close { margin-top: 15px; color: #CCCCCC; cursor: pointer; }
  </style>
</head>
<body>
  <div id="particles-js"></div>

  <div id="loginContainer" class="container">
    <h1 class="title">SevenO'Clock Drop</h1>
    <button id="loginButton" class="cta-button">Login with Pi</button>
  </div>

  <div id="appContainer" class="container" style="display: none;">
    <h1 class="title">SevenO'Clock Drop</h1>
    <div class="pot-display"><div class="pot-ring"></div><div class="pot-value" id="potValue">... π</div></div>
    <div class="countdown"><label>NEXT DROP IN</label><div id="timer">--:--:--</div></div>
    <button type="button" id="getEntriesButton" class="cta-button">GET ENTRIES</button>
    <div class="entry-info"><span>YOUR ENTRIES: <strong id="userEntries">--</strong></span></div>
    <div class="referral">
      <label for="referralCode">Referral Code</label><input type="text" id="referralCode" placeholder="Enter code for 5 bonus entries" /><button type="button" class="referral-button" onclick="applyReferral()">Apply Code</button><div id="referralStatus" class="referral-status"></div>
    </div>
  </div>

  <!-- Payment Modal HTML -->
  <div id="paymentModal" class="modal-overlay">
    <div class="modal-content">
      <h2 class="modal-title">Choose Your Tier</h2>
      <button class="tier-button" onclick="createPiPayment('1.00')">
        <span class="tier-entries">10 Entries</span> for 1.00 π
      </button>
      <button class="tier-button" onclick="createPiPayment('5.00')">
        <span class="tier-entries">50 Entries</span> for 5.00 π <br>
        <span class="tier-bonus">+ 10 Bonus Entries!</span>
      </button>
      <button class="tier-button" onclick="createPiPayment('10.00')">
        <span class="tier-entries">100 Entries</span> for 10.00 π <br>
        <span class="tier-bonus">+ 30 Bonus Entries!</span>
      </button>
      <div id="modalCloseButton" class="modal-close">Close</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <script>
    particlesJS("particles-js", { /* ... particles.js config from before ... */ });
  </script>

  <script>
    const API_BASE_URL = ''; let currentUser = null; let countdownInterval;
    const loginContainer = document.getElementById('loginContainer');
    const appContainer = document.getElementById('appContainer');
    const loginButton = document.getElementById('loginButton');
    const getEntriesButton = document.getElementById('getEntriesButton');
    const paymentModal = document.getElementById('paymentModal');
    const modalCloseButton = document.getElementById('modalCloseButton');

    async function authenticateWithPi() {
      try {
        const scopes = ['username', 'payments'];
        Pi.authenticate(scopes, onAuthComplete).then(auth => {
          currentUser = auth.user;
          loginContainer.style.display = 'none';
          appContainer.style.display = 'block';
          initializeApp();
        }).catch(error => { alert('Authentication failed. Please try again.'); });
      } catch (err) { alert('Could not connect to the Pi Network. Please try again later.'); }
    }

    async function initializeApp() {
      if (!currentUser) return;
      try {
        const response = await fetch(`${API_BASE_URL}/api/app-data?uid=${currentUser.uid}`);
        const data = await response.json();
        updateUI(data);
      } catch (error) { document.getElementById('potValue').textContent = "Error"; }
    }

    function updateUI(data) {
      document.getElementById('potValue').textContent = `${data.potValue} π`;
      document.getElementById('userEntries').textContent = data.userEntries;
      startCountdown(data.nextDropTimestamp);
    }

    function startCountdown(targetTimestamp) { /* ... same as before ... */ }
    async function applyReferral() { /* ... same as before ... */ }

    // --- NEW PAYMENT LOGIC ---
    function onAuthComplete({ payment }) {
      // This function is called by the Pi SDK after a payment is completed.
      // We will now send the payment data to our backend for verification.
      fetch(`${API_BASE_URL}/api/complete-payment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ paymentId: payment.identifier, txid: payment.transaction.txid })
      }).then(res => res.json()).then(data => {
        if (data.success) {
          alert('Payment successful! Your new entries have been added.');
          document.getElementById('userEntries').textContent = data.newEntryCount;
        } else {
          alert('Payment verification failed. Please contact support.');
        }
      }).catch(err => alert('An error occurred while verifying your payment.'));
    }

    async function createPiPayment(amount) {
      if (!currentUser) return alert("Please log in first.");
      paymentModal.style.display = 'none'; // Hide the modal
      try {
        // First, we ask our backend to create a payment record.
        const response = await fetch(`${API_BASE_URL}/api/create-payment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: amount, uid: currentUser.uid })
        });
        const paymentData = await response.json();
        if (!paymentData.success) throw new Error(paymentData.message);

        // Then, we use the Pi SDK to show the payment screen to the user.
        Pi.createPayment(paymentData.piPayment, {
          // These are the callback functions the Pi SDK will use.
          onReadyForServerApproval: (paymentId) => onAuthComplete({ payment: { identifier: paymentId, transaction: {} } }),
          onReadyForServerCompletion: (paymentId, txid) => onAuthComplete({ payment: { identifier: paymentId, transaction: { txid } } }),
          onCancel: (paymentId) => alert("Payment cancelled."),
          onError: (error, payment) => alert("An error occurred with the payment.")
        });
      } catch (error) {
        alert(`Error creating payment: ${error.message}`);
      }
    }

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
      loginButton.addEventListener('click', authenticateWithPi);
      getEntriesButton.addEventListener('click', () => { paymentModal.style.display = 'flex'; });
      modalCloseButton.addEventListener('click', () => { paymentModal.style.display = 'none'; });
    });
  </script>
</body>
</html>
