<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Seven O'Clock Drop</title>
  <!-- Pi Network SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    // Initialize Pi SDK
    Pi.init({ version: "2.0", sandbox: true });

    // Scopes for authentication
    const scopes = ['payments', 'username'];

    // Handle incomplete payments
    function onIncompletePaymentFound(payment) { 
      console.log('incomplete payment found');
      const paymentId = payment.identifier;
      const txid = payment.transaction.txid;
      fetch('/payment/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ paymentId, txid, debug: 'cancel' })
      })
      .then(res => res.json())
      .then(data => console.log('Incomplete payment handled:', data))
      .catch(err => console.error('Error handling incomplete payment:', err));
    }

    // Authenticate user on page load
    let uid = null;
    let accessToken = null;
    window.addEventListener('DOMContentLoaded', () => {
      if (window.Pi) {
        Pi.authenticate(scopes, onIncompletePaymentFound)
          .then(function(auth) {
            console.log(`Hi there! You're ready to make payments!`);
            uid = auth.user.uid;
            accessToken = auth.accessToken;
            document.getElementById('status').textContent = "‚úÖ Authenticated as: " + uid;
          })
          .catch(function(error) {
            console.error(error);
            document.getElementById('status').textContent = "‚ùå Authentication failed. Are you in Pi Browser?";
          });
      } else {
        document.getElementById('status').textContent = "‚ùå Pi SDK not available. Are you in Pi Browser?";
      }
    });
  </script>
</head>
<body>
  <h1>Seven O'Clock Drop</h1>
  <div id="status" style="margin-bottom:1em;color:gold;">Authenticating...</div>
  <button onclick="claimEntry()">Claim Free Entry</button>

  <script>
    function claimEntry() {
      if (!uid || !accessToken) {
        alert("‚ùå Not authenticated");
        return;
      }

      alert("üîÑ Starting payment...");

      Pi.createPayment({
        amount: 0,
        memo: "Seven O'Clock Drop Entry",
        metadata: { uid },
        callbacks: {
          onReadyForServerApproval: async paymentId => {
            await fetch('/api/approvePayment', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
              body: JSON.stringify({ paymentId, uid, amount: 0 })
            });
          },
          onReadyForServerCompletion: async paymentId => {
            await fetch('/api/approvePayment', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
              body: JSON.stringify({ paymentId, uid, amount: 0 })
            });
            alert("‚úÖ Entry claimed!");
          },
          onCancel: () => alert("‚ùå Payment cancelled"),
          onError: err => alert("‚ùå Payment failed: " + err.message)
        }
      });
    }
  </script>
</body>
</html>
