<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SevenO'Clock Drop</title>
  
  <!-- Pi SDK Scripts are in the correct place -->
  <script src="https://sdk.pi.network/pi-sdk.js"></script>
  
  <style>
    /* All the CSS is the same, but with one addition for the disabled button */
    @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;700&display=swap');
    :root { --background-color: #0c0a1a; --primary-glow: #a885ed; --secondary-glow: #f2d57e; --text-color: #e0e0e0; --font-family: 'Exo 2', sans-serif; }
    body { margin: 0; font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
    #nebula-background { position: fixed; top: 50%; left: 50%; min-width: 100%; min-height: 100%; width: auto; height: auto; transform: translateX(-50%) translateY(-50%); z-index: -1; background: url('https://www.nasa.gov/sites/default/files/thumbnails/image/j2m-shareable.jpg') no-repeat center center; background-size: cover; animation: slow-pan 120s linear infinite alternate; }
    @keyframes slow-pan { from { transform: translateX(-45%) translateY(-45%) scale(1.2); } to { transform: translateX(-55%) translateY(-55%) scale(1.2); } }
    .container { text-align: center; max-width: 400px; padding: 20px; z-index: 1; background: rgba(12, 10, 26, 0.6); backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(168, 133, 237, 0.2); box-shadow: 0 0 40px rgba(168, 133, 237, 0.2); }
    .title { font-size: 2.5rem; font-weight: 700; color: #fff; text-shadow: 0 0 10px var(--primary-glow), 0 0 20px var(--primary-glow); margin-bottom: 30px; }
    .pot-display { position: relative; margin: 30px auto; width: 220px; height: 220px; display: flex; justify-content: center; align-items: center; }
    .pot-core { width: 70%; height: 70%; background: radial-gradient(circle, var(--secondary-glow) 0%, var(--primary-glow) 60%, transparent 100%); border-radius: 50%; animation: core-pulse 4s ease-in-out infinite; box-shadow: 0 0 20px var(--primary-glow), 0 0 40px var(--secondary-glow); }
    @keyframes core-pulse { 0% { transform: scale(0.95); opacity: 0.8; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(0.95); opacity: 0.8; } }
    .pot-value { position: absolute; font-size: 2rem; font-weight: 700; color: #fff; text-shadow: 0 0 5px #000; }
    .countdown label { font-size: 1rem; color: var(--text-color); font-weight: 300; }
    #timer { font-size: 2rem; color: #fff; margin: 10px 0 20px 0; font-weight: 700; }
    .cta-button { background: linear-gradient(90deg, var(--primary-glow), var(--secondary-glow)); border: none; color: #0c0a1a; padding: 15px 30px; font-size: 1.2rem; font-weight: 700; border-radius: 50px; cursor: pointer; margin-top: 10px; transition: all 0.3s ease; }
    .cta-button:hover { transform: scale(1.05); box-shadow: 0 0 20px var(--secondary-glow); }
    /* NEW STYLE FOR DISABLED BUTTON */
    .cta-button:disabled { background: #555; color: #999; cursor: not-allowed; transform: none; box-shadow: none; }
    .entry-info { margin-top: 20px; font-size: 1.1rem; }
    .referral { margin-top: 25px; }
    .referral input { padding: 10px; width: 80%; border-radius: 8px; border: 1px solid var(--primary-glow); background-color: rgba(0,0,0,0.5); color: #fff; font-family: var(--font-family); }
    .referral-button { margin-top: 10px; padding: 8px 16px; background: var(--primary-glow); border: none; border-radius: 20px; color: #0c0a1a; cursor: pointer; font-weight: 700; }
    .referral-status { min-height: 1.2em; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(12, 10, 26, 0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; }
    .modal-overlay.visible { display: flex; opacity: 1; }
    .modal-content { background: #1e1e1e; padding: 30px; border-radius: 15px; border: 1px solid var(--primary-glow); width: 90%; max-width: 380px; box-shadow: 0 0 50px var(--primary-glow); transform: scale(0.9); transition: transform 0.3s ease; }
    .modal-overlay.visible .modal-content { transform: scale(1); }
    .modal-title { font-size: 1.8rem; color: #fff; margin-bottom: 25px; text-shadow: 0 0 10px var(--secondary-glow); }
    .tier-button { display: block; width: 100%; padding: 20px; margin: 15px 0; border-radius: 10px; border: 1px solid var(--primary-glow); background-color: rgba(12, 10, 26, 0.5); color: #fff; font-size: 1.1rem; cursor: pointer; text-align: left; transition: background-color 0.3s ease, transform 0.3s ease; }
    .tier-button:hover { background-color: var(--primary-glow); color: #0c0a1a; transform: scale(1.02); }
    .tier-entries { font-weight: 700; color: var(--secondary-glow); }
    .tier-bonus { font-size: 0.9rem; color: #fff; opacity: 0.8; }
    .modal-close { margin-top: 20px; color: var(--text-color); cursor: pointer; font-weight: 300; }
  </style>
</head>
<body>
  <div id="nebula-background"></div>

  <div id="loginContainer" class="container">
    <h1 class="title">SevenO'Clock Drop</h1>
    <!-- The button now starts as disabled -->
    <button id="loginButton" class="cta-button" disabled>Connecting to Pi...</button>
  </div>

  <div id="appContainer" class="container" style="display: none;">
    <!-- The rest of the app HTML is the same -->
    <h1 class="title">SevenO'Clock Drop</h1>
    <div class="pot-display"><div class="pot-core"></div><div class="pot-value" id="potValue">... π</div></div>
    <div class="countdown"><label>NEXT DROP IN</label><div id="timer">--:--:--</div></div>
    <button type="button" id="getEntriesButton" class="cta-button">Get Entries</button>
    <div class="entry-info"><span>YOUR ENTRIES: <strong id="userEntries">--</strong></span></div>
    <div class="referral">
      <label for="referralCode">Referral Code</label><input type="text" id="referralCode" placeholder="Enter code for bonus entries" /><button type="button" class="referral-button" onclick="applyReferral()">Apply</button><div id="referralStatus" class="referral-status"></div>
    </div>
  </div>

  <div id="paymentModal" class="modal-overlay">
    <!-- The modal HTML is the same -->
    <div class="modal-content">
      <h2 class="modal-title">Select Tier</h2>
      <button class="tier-button" onclick="createPiPayment('1.00')"><span class="tier-entries">10 Entries</span> for 1.00 π</button>
      <button class="tier-button" onclick="createPiPayment('5.00')"><span class="tier-entries">60 Entries</span> for 5.00 π <br><span class="tier-bonus">(Includes 10 Bonus Entries)</span></button>
      <button class="tier-button" onclick="createPiPayment('10.00')"><span class="tier-entries">130 Entries</span> for 10.00 π <br><span class="tier-bonus">(Includes 30 Bonus Entries)</span></button>
      <div id="modalCloseButton" class="modal-close">Cancel</div>
    </div>
  </div>

  <script>
    // --- DOM ELEMENTS ---
    const loginContainer = document.getElementById('loginContainer');
    const appContainer = document.getElementById('appContainer');
    const loginButton = document.getElementById('loginButton');
    // ... other elements are the same

    // --- NEW: INITIALIZATION LOGIC ---
    // This code runs as soon as the page loads.
    document.addEventListener('DOMContentLoaded', () => {
      try {
        // We initialize the Pi SDK here.
        Pi.init({ version: "2.0", sandbox: true });
        
        // If Pi.init() succeeds, we enable the login button.
        loginButton.disabled = false;
        loginButton.textContent = 'Login with Pi';
        
        // We then attach the function to the button.
        loginButton.addEventListener('click', authenticateWithPi);

      } catch (err) {
        // If Pi.init() fails, it means we are not in the Pi Browser.
        // The button will remain disabled and show an error message.
        console.error('Failed to initialize Pi SDK', err);
        loginButton.textContent = 'Error: Use Pi Browser';
        alert('This app must be run from the Pi Browser.');
      }
      
      // Attach listeners for the rest of the app
      const getEntriesButton = document.getElementById('getEntriesButton');
      const paymentModal = document.getElementById('paymentModal');
      const modalCloseButton = document.getElementById('modalCloseButton');
      getEntriesButton.addEventListener('click', () => { paymentModal.classList.add('visible'); });
      modalCloseButton.addEventListener('click', () => { paymentModal.classList.remove('visible'); });
    });

    // --- AUTHENTICATION ---
    // This function is now only called when the button is clicked AND enabled.
    async function authenticateWithPi() {
      try {
        const scopes = ['username', 'payments'];
        const onAuthComplete = (auth) => {
          window.currentUser = auth.user;
          loginContainer.style.display = 'none';
          appContainer.style.display = 'block';
          initializeApp();
        };
        Pi.authenticate(scopes, onAuthComplete).catch(err => {
          alert('Authentication was cancelled or failed.');
        });
      } catch (err) {
        // This catch is now a fallback, the main check is done at initialization.
        alert('An unexpected error occurred during authentication.');
      }
    }

    // --- The rest of the JavaScript functions (initializeApp, updateUI, etc.) are the same ---
    async function initializeApp() {
        if (!window.currentUser) return;
        try {
            const response = await fetch(`/api/app-data?uid=${window.currentUser.uid}`);
            if (!response.ok) throw new Error('Server connection failed');
            const data = await response.json();
            updateUI(data);
        } catch (error) { document.getElementById('potValue').textContent = "Error"; }
    }
    function updateUI(data) {
        document.getElementById('potValue').textContent = `${data.potValue} π`;
        document.getElementById('userEntries').textContent = data.userEntries;
        startCountdown(data.nextDropTimestamp);
    }
    function startCountdown(targetTimestamp) {
        let countdownInterval = window.countdownInterval;
        if (countdownInterval) clearInterval(countdownInterval);
        const timerElement = document.getElementById('timer');
        window.countdownInterval = setInterval(() => {
            const diff = targetTimestamp - Date.now();
            if (diff < 0) { timerElement.textContent = "00:00:00"; clearInterval(window.countdownInterval); return; }
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            timerElement.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }, 1000);
    }
    async function applyReferral() {
        const code = document.getElementById("referralCode").value.trim();
        const status = document.getElementById("referralStatus");
        if (!window.currentUser || !code) return;
        try {
            const response = await fetch(`/api/apply-referral`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code, uid: window.currentUser.uid })
            });
            const result = await response.json();
            status.textContent = result.message;
            if (result.success) {
                status.style.color = "#00FFAA";
                document.getElementById('userEntries').textContent = result.newEntryCount;
            } else {
                status.style.color = "#FF4444";
            }
        } catch (error) {
            status.textContent = 'Error connecting to server.';
            status.style.color = "#FF4444";
        }
    }
    function onPaymentComplete(payment) {
        if (!payment) return;
        fetch(`/api/complete-payment`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId: payment.identifier, txid: payment.transaction.txid })
        }).then(res => res.json()).then(data => {
            if (data.success) {
                alert('Payment successful! Your new entries have been added.');
                initializeApp(); // Re-fetch data to get the new entry count
            } else {
                alert(`Payment verification failed: ${data.message}`);
            }
        }).catch(err => alert('An error occurred while verifying your payment.'));
    }
    async function createPiPayment(amount) {
        if (!window.currentUser) return alert("Please log in first.");
        document.getElementById('paymentModal').classList.remove('visible');
        try {
            const response = await fetch(`/api/create-payment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: amount, uid: window.currentUser.uid })
            });
            const paymentData = await response.json();
            if (!paymentData.success) throw new Error(paymentData.message);
            Pi.createPayment(paymentData.piPayment, {
                onReadyForServerApproval: (paymentId) => onPaymentComplete({ identifier: paymentId, transaction: {} }),
                onReadyForServerCompletion: (paymentId, txid) => onPaymentComplete({ identifier: paymentId, transaction: { txid } }),
                onCancel: (paymentId) => alert("Payment cancelled."),
                onError: (error, payment) => alert("An error occurred with the payment.")
            });
        } catch (error) {
            alert(`Error creating payment: ${error.message}`);
        }
    }
  </script>
</body>
</html>
